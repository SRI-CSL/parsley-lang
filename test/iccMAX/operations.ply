type operation =
 | If of [operation]
 | If_else of [operation] * [operation]
 // ... other ops

fun num_ops (o: operation) -> int = {
  (case o of
   | operation::If(s) ->
       1 + List.length(s)
   | operation::If_else(s, t) ->
       2 + List.length(s) + List.length(t)
   // other ops
   )
}

format {
  U32 := UInt32<endian=endian::Big()> ;;

  Operation o {op: operation} :=
      !"if  "! t=U32
      !"else"! u=U32
      tv = {;; let v = View.get_current() in
               View.restrict(v, 0, 8*t) }
      uv = {;; let v = View.get_current() in
               let v = View.restrict_from(v, 8*t) in
               View.restrict(v, 0, 8*u) }
      ifops  = @[tv, OpStream<nops = t>]
      elsops = @[uv, OpStream<nops = u>]
      { o.op := operation::If_else(ifops, elsops) }
   ;
      !"if  "! t=U32
      tv = {;; let v = View.get_current() in
               View.restrict(v, 0, 8*t) }
      ifops  = @[tv, OpStream<nops = t>]
      { o.op := operation::If(ifops) }

   // ... other ops

   ;;

  OpStream os (nops: int) {ops: [operation]} :=
      (| l : [operation] := [], cnt : int := 0 |)

      ( [cnt < nops]
        o=Operation
        { l := o.op :: l;
          cnt := cnt + num_ops(o.op) }
      ) *
      [ cnt = nops ]

      { os.ops := List.rev(l) }
}
