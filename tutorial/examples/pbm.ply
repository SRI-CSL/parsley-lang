type pbm_file_contents = {
  magic_bytes: [byte],
  height: int,
  width: int,
  img: [[byte]]}

format {
  Comment := !"#"! (# [AsciiCharS \ "\n" \ "\r"]*  ["\r" | "\n"] #);; // is this correct?
  Whitespace := (# [" " | "\t" | "\r" | "\n"] #);;  // missing VT, FF (vertical tabulation, form feed)
  NonNewlineWhitespace := (# [" " | "\t"] #);;
  DimensionValue := (#[DigitS]+#);;
  BinaryDigit := (# ["0" | "1"] #);;
  PixelPlusWhitespace := (# BinaryDigit Whitespace* #);;
  TokenSeparator := (# (Comment | Whitespace)* Whitespace+ (Comment | Whitespace)* #);;
  TokenSeparatorRaster := (# TokenSeparator Whitespace #);;
  MagicBytes := !"P1"!;;
  Junk := ; (# Whitespace AsciiCharS* #);;

  PBM_FC fc {pbm_file_contents} :=
    magic_bytes = MagicBytes
    TokenSeparator
    height = DimensionValue
    TokenSeparator
    width = DimensionValue
    TokenSeparator
    raster_size = { ;;
                    let raster_size = Int.of_bytes_unsafe(width) * Int.of_bytes_unsafe(height) in
                    raster_size}
    img = (PixelPlusWhitespace^raster_size)
    junk = Junk
    {
      fc.magic_bytes := magic_bytes;
      fc.height := Int.of_bytes_unsafe(height);
      fc.width := Int.of_bytes_unsafe(width);
      fc.img := img
    }
}
